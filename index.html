<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionAI - Clasificador de Residuos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <style>
        /* CSS RESET & BASE STYLES */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-image: url('reciclaje_blur.jpg'); /* Asegúrate de tener estas imágenes */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #333;
            transition: background-image 0.5s ease, color 0.5s ease;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh; /* Para que el footer se quede abajo */
            display: flex;
            flex-direction: column;
        }

        body.dark-mode {
            background-image: url('reciclaje_blur_dark.jpg'); /* Asegúrate de tener estas imágenes */
            color: #e0e0e0;
        }

        /* MATERIAL UI INSPIRED STYLES */
        :root {
            --primary-color: #4CAF50; /* Green */
            --primary-dark: #388E3C;
            --primary-light: #81C784;
            --accent-color: #FFC107; /* Amber */
            --text-color: #333;
            --text-color-dark: #e0e0e0;
            --background-light: #f4f6f8;
            --background-dark: #212121;
            --card-background-light: rgba(255, 255, 255, 0.95);
            --card-background-dark: rgba(40, 40, 40, 0.95);
            --border-color-light: #e0e0e0;
            --border-color-dark: #555;
            --shadow-light: 0 4px 10px rgba(0,0,0,0.15);
            --shadow-dark: 0 4px 10px rgba(0,0,0,0.5);
        }

        body.dark-mode {
            --text-color: var(--text-color-dark);
            --background-light: var(--background-dark);
            --card-background-light: var(--card-background-dark);
            --border-color-light: var(--border-color-dark);
            --shadow-light: var(--shadow-dark);
        }

        /* HEADER & NAVIGATION */
        header {
            background: var(--card-background-light);
            padding: 1rem 20px;
            box-shadow: var(--shadow-light);
            text-align: center;
            position: relative;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        header h1 {
            margin: 0;
            font-size: clamp(1.8rem, 4vw, 2.8rem);
            color: var(--primary-color);
            flex-grow: 1; /* Permite que ocupe el espacio disponible */
            text-align: left;
            padding-left: 10px;
        }

        .menu-button {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 2.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .menu-button:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }
        body.dark-mode .menu-button {
            color: var(--primary-light);
        }
        body.dark-mode .menu-button:hover {
            background-color: rgba(129, 199, 132, 0.1);
        }

        /* SIDE NAV */
        .sidenav {
            height: 100%;
            width: 0; /* Hidden by default */
            position: fixed;
            z-index: 2000;
            top: 0;
            right: 0; /* Slide in from right */
            background-color: var(--card-background-light);
            overflow-x: hidden;
            transition: 0.5s; /* Smooth transition */
            padding-top: 60px;
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
        }

        .sidenav a {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 1.5rem;
            color: var(--text-color);
            display: block;
            transition: 0.3s;
            border-bottom: 1px solid var(--border-color-light);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sidenav a:hover {
            background-color: var(--primary-light);
            color: white;
        }
        .sidenav a:hover .material-icons {
            color: white;
        }

        .sidenav .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 3rem;
            margin-left: 50px;
            color: var(--primary-color);
            border-bottom: none;
        }
        .sidenav .closebtn:hover {
            background-color: transparent;
            color: var(--primary-dark);
        }

        body.dark-mode .sidenav a {
            color: var(--text-color-dark);
            border-bottom: 1px solid var(--border-color-dark);
        }
        body.dark-mode .sidenav a:hover {
            background-color: var(--primary-dark);
            color: white;
        }
        body.dark-mode .sidenav .closebtn {
            color: var(--primary-light);
        }
        body.dark-mode .sidenav .closebtn:hover {
            color: var(--primary-color);
        }

        /* MAIN CONTENT LAYOUT */
        main {
            flex-grow: 1; /* Permite que el contenido principal ocupe el espacio restante */
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            background: var(--card-background-light);
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            position: relative;
            z-index: 100;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-card {
            flex: 1;
            min-width: 320px;
            padding: 25px;
            border-radius: 12px;
            background-color: var(--background-light);
            box-shadow: inset 0 0 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color-light);
        }
        .section-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-light), inset 0 0 8px rgba(0,0,0,0.1);
        }

        body.dark-mode .section-card {
            background-color: #333;
            box-shadow: inset 0 0 8px rgba(255,255,255,0.1);
            border: 1px solid var(--border-color-dark);
        }
        body.dark-mode .section-card:hover {
            box-shadow: var(--shadow-dark), inset 0 0 8px rgba(255,255,255,0.15);
        }

        h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: clamp(1.5rem, 3.5vw, 2.2rem);
            font-weight: 500;
        }
        body.dark-mode h2 {
            color: var(--primary-light);
        }

        /* CAMERA & CANVAS */
        #webcam {
            display: none;
            width: 100%;
            max-width: 640px; /* Standard webcam width */
            height: auto; /* Maintain aspect ratio */
            border: 3px solid var(--primary-color);
            border-radius: 8px;
            margin-top: 15px;
            background-color: #000;
            transition: border-color 0.3s ease;
            position: relative; /* For the overlay label */
            overflow: hidden; /* Ensure label doesn't spill out */
        }
        body.dark-mode #webcam {
            border: 3px solid var(--primary-light);
        }

        /* Video container for relative positioning of label */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden; /* Ensures label stays within bounds */
        }

        /* Styles for the large prediction label over the camera */
        #predictionLabel {
            position: absolute;
            bottom: 0; /* Position at the bottom of the camera feed */
            left: 0;
            width: 100%;
            padding: 15px 10px; /* Adjusted padding */
            background-color: rgba(0, 123, 255, 0.9); /* Default Blue */
            color: white;
            font-size: 2.2rem; /* Adjusted font size for mobile */
            font-weight: 700;
            text-align: center;
            border-radius: 0 0 8px 8px; /* Rounded bottom corners to match video */
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3); /* Shadow on top */
            transition: background-color 0.4s ease, transform 0.3s ease;
            display: none; /* Hidden by default */
            z-index: 2; /* Above the video, below other UI elements */
            animation: slideUp 0.4s ease-out; /* Animation for appearance */
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(100%); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Colors for different categories */
        #predictionLabel.organico { background-color: rgba(139, 69, 19, 0.9); } /* Brown */
        #predictionLabel.reciclable { background-color: rgba(52, 199, 89, 0.9); } /* Green */
        #predictionLabel.no-reciclable { background-color: rgba(255, 69, 58, 0.9); } /* Red */
        #predictionLabel.no-detectado { background-color: rgba(100, 100, 100, 0.9); } /* Grey */


        /* Buttons - Material Design Inspired */
        .controls {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button, .file-upload-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        button:hover, .file-upload-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.25);
        }
        button:active, .file-upload-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .material-icons {
            font-size: 1.4rem;
        }

        /* UPLOAD SECTION */
        #outputImage {
            max-width: 100%;
            height: auto;
            border: 3px solid #007bff;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        body.dark-mode #outputImage {
            border: 3px solid #66b3ff;
        }

        /* ABOUT / HOW TO USE / CONTACT SECTIONS - Initial state hidden */
        .info-section {
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            text-align: center;
        }

        .info-section.active {
            display: flex; /* Show when active */
        }

        .info-card {
            background-color: var(--background-light);
            padding: 25px;
            border-radius: 12px;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.05);
            text-align: left;
            border: 1px solid var(--border-color-light);
            animation: slideIn 0.6s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        body.dark-mode .info-card {
            background-color: #333;
            border: 1px solid var(--border-color-dark);
        }

        .info-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.8rem;
            font-weight: 500;
        }
        body.dark-mode .info-card h3 {
            color: var(--primary-light);
        }

        .info-card p, .info-card ul {
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--text-color);
        }
        body.dark-mode .info-card p, body.dark-mode .info-card ul {
            color: var(--text-color-dark);
        }
        .info-card ul {
            list-style: none;
            padding-left: 0;
        }
        .info-card ul li {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .info-card ul li .material-icons {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-top: 2px;
        }
        body.dark-mode .info-card ul li .material-icons {
            color: var(--primary-light);
        }

        /* GOOGLE MAPS */
        #map {
            width: 100%;
            height: 400px; /* Fixed height for the map */
            border-radius: 8px;
            border: 1px solid var(--border-color-light);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        body.dark-mode #map {
            border: 1px solid var(--border-color-dark);
        }

        /* STATS SECTION */
        .stats-section {
            background-color: var(--card-background-light);
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            padding: 25px;
            margin: 30px auto;
            max-width: 1200px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 20px;
            animation: fadeIn 0.8s ease-out 0.2s backwards; /* Delayed animation */
        }
        body.dark-mode .stats-section {
            background-color: var(--card-background-dark);
        }

        .stat-item {
            text-align: center;
            background-color: var(--background-light);
            padding: 20px;
            border-radius: 10px;
            flex: 1;
            min-width: 220px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color-light);
        }
        body.dark-mode .stat-item {
            background-color: #333;
            border: 1px solid var(--border-color-dark);
        }

        .stat-item h3 {
            color: #007bff; /* Blue for titles */
            font-size: 1.6rem;
            margin-bottom: 12px;
            font-weight: 500;
        }
        body.dark-mode .stat-item h3 {
            color: #66b3ff;
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        body.dark-mode .stat-value {
            color: var(--primary-light);
        }

        /* FOOTER */
        footer {
            text-align: center;
            padding: 25px;
            margin-top: auto; /* Push footer to the bottom */
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.95rem;
            position: relative;
            z-index: 1000;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        body.dark-mode footer {
            background: rgba(20, 20, 20, 0.9);
        }

        /* THEME TOGGLE (FAB Button) */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--accent-color);
            color: #333;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1100;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }
        .theme-toggle:hover {
            background-color: #fbc02d; /* Darker amber */
            transform: scale(1.08);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        body.dark-mode .theme-toggle {
            background-color: #9E9E9E; /* Grey for dark mode toggle */
            color: white;
        }
        body.dark-mode .theme-toggle:hover {
            background-color: #757575;
        }

        /* ANIMATIONS REMOVED FOR ALL DEVICES (Olas y Particulas) */
        .wave-background, #particles {
            display: none !important;
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            header {
                padding: 1rem 15px;
            }
            header h1 {
                font-size: 2rem;
            }
            .menu-button {
                font-size: 2rem;
            }
            .sidenav {
                width: 100%; /* Full width on smaller screens */
                right: -100%; /* Hidden off-screen to the right */
            }
            .sidenav.open {
                right: 0;
            }
            .sidenav a {
                font-size: 1.2rem;
                padding: 12px 20px;
            }
            .sidenav .closebtn {
                font-size: 2.5rem;
                right: 15px;
            }
            main {
                margin: 15px auto;
                padding: 15px;
                gap: 20px;
            }
            .section-card {
                padding: 20px;
                min-width: unset; /* Remove min-width on small screens */
            }
            h2 {
                font-size: 1.8rem;
            }
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            button, .file-upload-button {
                padding: 10px 20px;
                font-size: 1rem;
            }
            /* Adjustments for #predictionLabel on mobile */
            #predictionLabel {
                font-size: 1.6rem; /* Smaller font on mobile */
                padding: 10px; /* Reduced padding on mobile */
            }
            .stats-section {
                padding: 20px;
                margin: 20px auto;
            }
            .stat-item {
                min-width: 150px;
                padding: 15px;
            }
            .stat-item h3 {
                font-size: 1.3rem;
            }
            .stat-value {
                font-size: 2.2rem;
            }
            .theme-toggle {
                width: 45px;
                height: 45px;
                font-size: 1.4rem;
                bottom: 15px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>VisionAI</h1>
        <button class="menu-button" onclick="openNav()">
            <span class="material-icons">menu</span>
        </button>
    </header>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>
        <a href="#home-section" onclick="showSection('home-section'); closeNav();"><span class="material-icons">home</span> Inicio</a>
        <a href="#about-section" onclick="showSection('about-section'); closeNav();"><span class="material-icons">info</span> Sobre Nosotros</a>
        <a href="#how-to-use-section" onclick="showSection('how-to-use-section'); closeNav();"><span class="material-icons">help</span> ¿Cómo se usa?</a>
        <a href="#contact-section" onclick="showSection('contact-section'); closeNav();"><span class="material-icons">mail</span> Contacto</a>
        <a href="#location-section" onclick="showSection('location-section'); closeNav();"><span class="material-icons">location_on</span> Ubicación</a>
    </div>

    <main id="main-content">
        <section id="home-section" class="section-card active">
            <h2>Clasificador de Residuos</h2>
            <p>Usa tu cámara o sube una imagen para identificar el tipo de residuo.</p>
            <div class="video-container">
                <video id="webcam" autoplay playsinline muted></video>
                <div id="predictionLabel"></div>
            </div>
            <div class="controls">
                <button id="startCameraButton"><span class="material-icons">videocam</span> Iniciar Cámara</button>
                <button id="stopCameraButton" style="display: none;"><span class="material-icons">videocam_off</span> Detener Cámara</button>
                <input type="file" id="uploadInput" accept="image/*" style="display: none;">
                <button id="uploadButton" class="file-upload-button"><span class="material-icons">upload_file</span> Subir Imagen</button>
            </div>
            <img id="outputImage" src="#" alt="Imagen subida" style="display: none;">
            <button id="processImageButton" style="display: none;"><span class="material-icons">check_circle</span> Procesar Imagen</button>
            <button id="clearImageButton" style="display: none;"><span class="material-icons">clear</span> Limpiar</button>
        </section>

        <section id="about-section" class="info-section">
            <h2>Sobre Nosotros</h2>
            <div class="info-card">
                <h3>Nuestra Misión</h3>
                <p>En VisionAI, creemos en la tecnología como herramienta para un futuro más sostenible. Nuestra misión es facilitar la correcta clasificación de residuos a través de la inteligencia artificial, empoderando a individuos y comunidades para que contribuyan activamente al reciclaje y la reducción del impacto ambiental.</p>
            </div>
            <div class="info-card">
                <h3>¿Quiénes Somos?</h3>
                <p>Somos un equipo apasionado de desarrolladores, ingenieros y entusiastas del medio ambiente, dedicados a crear soluciones innovadoras que aborden los desafíos actuales de la gestión de residuos. VisionAI es el resultado de un proyecto de semestre enfocado en aplicar el aprendizaje automático para el bien del planeta.</p>
            </div>
            <div class="info-card">
                <h3>Nuestra Visión</h3>
                <p>Visualizamos un mundo donde la correcta clasificación de residuos es intuitiva, accesible y una parte integral de la vida diaria de todos, contribuyendo significativamente a la economía circular y la preservación de nuestros recursos naturales.</p>
            </div>
        </section>

        <section id="how-to-use-section" class="info-section">
            <h2>¿Cómo se Usa?</h2>
            <div class="info-card">
                <h3>Clasificación con Cámara</h3>
                <ul>
                    <li><span class="material-icons">looks_one</span> Haz clic en "Iniciar Cámara".</li>
                    <li><span class="material-icons">looks_two</span> Coloca el objeto frente a la cámara, asegurándote de que esté bien iluminado y ocupe una parte significativa del encuadre.</li>
                    <li><span class="material-icons">looks_3</span> Espera unos segundos y la aplicación mostrará en pantalla grande si el objeto es "Orgánico", "Reciclable" o "No Reciclable".</li>
                    <li><span class="material-icons">looks_4</span> Haz clic en "Detener Cámara" cuando hayas terminado.</li>
                </ul>
            </div>
            <div class="info-card">
                <h3>Clasificación con Imagen Subida</h3>
                <ul>
                    <li><span class="material-icons">looks_one</span> Haz clic en "Subir Imagen" y selecciona una foto de tu dispositivo.</li>
                    <li><span class="material-icons">looks_two</span> Una vez que la imagen se cargue, haz clic en "Procesar Imagen".</li>
                    <li><span class="material-icons">looks_3</span> La aplicación analizará la imagen y mostrará la categoría del residuo.</li>
                    <li><span class="material-icons">looks_4</span> Haz clic en "Limpiar" para subir otra imagen.</li>
                </ul>
            </div>
            <div class="info-card">
                <h3>Consejos para Mejor Detección</h3>
                <ul>
                    <li><span class="material-icons">lightbulb</span> Asegúrate de que haya buena iluminación.</li>
                    <li><span class="material-icons">center_focus_strong</span> El objeto debe estar claro y centrado.</li>
                    <li><span class="material-icons">clear_all</span> Evita fondos muy cargados que puedan confundir al modelo.</li>
                    <li><span class="material-icons">compare</span> Clasifica un objeto a la vez para mayor precisión.</li>
                </ul>
            </div>
        </section>

        <section id="contact-section" class="info-section">
            <h2>Contacto</h2>
            <div class="info-card">
                <h3>¿Preguntas o Sugerencias?</h3>
                <p>Nos encantaría escuchar de ti. Si tienes alguna pregunta, sugerencia o deseas colaborar, no dudes en contactarnos.</p>
                <ul>
                    <li><span class="material-icons">email</span> Email: info@visionai.com</li>
                    <li><span class="material-icons">phone</span> Teléfono: +502 1234 5678</li>
                    <li><span class="material-icons">public</span> Sitio Web: www.visionai.com (ejemplo)</li>
                    <li><span class="material-icons">location_on</span> Dirección: 123 Calle de la Innovación, Ciudad de Guatemala, Guatemala</li>
                </ul>
            </div>
            <div class="info-card">
                <h3>Síguenos en Redes Sociales</h3>
                <p>Mantente al día con nuestras últimas noticias y actualizaciones:</p>
                <ul>
                    <li><span class="material-icons">facebook</span> Facebook: /VisionAIGT</li>
                    <li><span class="material-icons">link</span> Instagram: @VisionAIGT</li>
                    <li><span class="material-icons">link</span> Twitter: @VisionAIGT</li>
                </ul>
            </div>
        </section>

        <section id="location-section" class="info-section">
            <h2>Nuestra Ubicación</h2>
            <div class="info-card">
                <p>Puedes encontrarnos en el siguiente punto de referencia (ejemplo):</p>
                <div id="map"></div>
                <p style="margin-top: 15px;">**Nota:** Este es un ejemplo de ubicación. Para ver tu ubicación real, necesitarás una API Key de Google Maps y configurar un mapa interactivo.</p>
            </div>
        </section>
    </main>

    <section class="stats-section">
        <div class="stat-item">
            <h3>Objetos Clasificados</h3>
            <div id="stat1" class="stat-value">0</div>
        </div>
        <div class="stat-item">
            <h3>Reducción de CO2 (kg)</h3>
            <div id="stat2" class="stat-value">0</div>
        </div>
        <div class="stat-item">
            <h3>Porcentaje Reciclado</h3>
            <div id="stat3" class="stat-value">0%</div>
        </div>
    </section>

    <footer>
        <p>© 2024 VisionAI. Todos los derechos reservados. Desarrollado con ❤️ y IA.</p>
    </footer>

    <button id="themeToggle" class="theme-toggle">
        <span class="material-icons">dark_mode</span>
    </button>

    <script>
        // Teachable Machine Model URL
        const URL = "https://teachablemachine.withgoogle.com/models/wtTPTc2fr/";
        let model, webcam, maxPredictions;

        // DOM Elements
        const video = document.getElementById('webcam');
        const canvas = document.createElement('canvas'); // Create a hidden canvas for internal use
        const ctx = canvas.getContext('2d');
        const startCameraButton = document.getElementById('startCameraButton');
        const stopCameraButton = document.getElementById('stopCameraButton');
        const uploadInput = document.getElementById('uploadInput');
        const uploadButton = document.getElementById('uploadButton');
        const outputImage = document.getElementById('outputImage');
        const processImageButton = document.getElementById('processImageButton');
        const clearImageButton = document.getElementById('clearImageButton');
        const predictionLabel = document.getElementById('predictionLabel');
        const themeToggle = document.getElementById('themeToggle');
        const mainContent = document.getElementById('main-content');

        // State variables
        let animationFrameId;
        let isWebcamActive = false;
        const confidenceThreshold = 0.85; // 85% de probabilidad de similitud
        let lastPredictionClass = ''; // To track if the prediction changed
        const predictionDisplayDuration = 2000; // Display prediction for 2 seconds
        let predictionHideTimeout;

        // Stats data (to keep track of the actual values)
        const statsData = {
            'stat1': { value: 0, target: 1500, text: '' }, // Objetos Clasificados
            'stat2': { value: 0, target: 5000, text: '' }, // Reducción de CO2 (kg)
            'stat3': { value: 0, target: 80, text: '%' } // Porcentaje Reciclado
        };

        // SIDE NAV FUNCTIONS
        function openNav() {
            document.getElementById("mySidenav").style.width = "280px"; // Adjust width for mobile
        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
        }

        // SECTION MANAGEMENT
        function showSection(sectionId) {
            const sections = document.querySelectorAll('#main-content .section-card, #main-content .info-section');
            sections.forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none'; // Hide all sections
            });

            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.add('active');
                activeSection.style.display = 'flex'; // Show the active section (flex for layout)

                // Stop camera if navigating away from home
                if (sectionId !== 'home-section' && isWebcamActive) {
                    stopWebcam();
                }

                // Initialize Google Map if the location section is active
                if (sectionId === 'location-section') {
                    initMap();
                }
            }
        }

        // GOOGLE MAPS INITIALIZATION (Requires API Key)
        function initMap() {
            // Replace with your desired coordinates for Guatemala City
            const guatemalaCity = { lat: 14.6349, lng: -90.5069 };
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: guatemalaCity,
            });
            new google.maps.Marker({
                position: guatemalaCity,
                map: map,
                title: "Nuestra Ubicación de Ejemplo",
            });
        }

        // Add Google Maps script dynamically (only if needed)
        function loadGoogleMapsScript() {
            // Check if script is already loaded
            if (document.querySelector('script[src*="maps.googleapis.com"]')) {
                return;
            }
            const script = document.createElement('script');
            // Replace YOUR_API_KEY with your actual Google Maps API Key
            script.src = `https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }


        // TEACABLE MACHINE MODEL FUNCTIONS
        async function initModel() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            try {
                // Load the model and metadata
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                console.log('Teachable Machine model loaded successfully.');
            } catch (error) {
                console.error('Error loading Teachable Machine model:', error);
                alert('Error al cargar el modelo de detección. Por favor, recarga la página o revisa la URL del modelo.');
            }
        }

        async function loop() {
            if (!isWebcamActive) return; // Stop loop if webcam is not active

            // Draw current video frame to hidden canvas for prediction
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            // Use the hidden canvas for prediction
            const prediction = await model.predict(canvas);

            let detectedClass = 'No detectado';
            let bestProbability = 0;

            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction = prediction[i].className;
                const probability = parseFloat(prediction[i].probability.toFixed(2));

                if (probability >= confidenceThreshold && probability > bestProbability) {
                    bestProbability = probability;
                    detectedClass = classPrediction;
                }
            }

            // Only update the label and stats if the detected class is different
            if (detectedClass !== lastPredictionClass) {
                clearTimeout(predictionHideTimeout); // Clear any previous hide timeout
                displayPrediction(detectedClass);
                lastPredictionClass = detectedClass; // Update last detected class

                // Schedule to hide/reset after a short duration if no new detection
                predictionHideTimeout = setTimeout(() => {
                    if (detectedClass === lastPredictionClass) { // Only hide if still the same prediction
                         // predictionLabel.style.display = 'none'; // Keep it visible but potentially reset text
                         displayPrediction('No detectado'); // Reset to 'No detectado'
                         lastPredictionClass = 'No detectado';
                    }
                }, predictionDisplayDuration);
            }

            animationFrameId = window.requestAnimationFrame(loop);
        }


        async function predictImage(imageElement) {
            if (!model) {
                alert('El modelo aún no está cargado. Por favor, espera un momento.');
                return;
            }

            // Create a temporary canvas to draw the image for prediction
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = imageElement.naturalWidth;
            tempCanvas.height = imageElement.naturalHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(imageElement, 0, 0, tempCanvas.width, tempCanvas.height);

            const prediction = await model.predict(tempCanvas);
            let detectedClass = 'No detectado';
            let bestProbability = 0;

            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction = prediction[i].className;
                const probability = parseFloat(prediction[i].probability.toFixed(2));

                if (probability >= confidenceThreshold && probability > bestProbability) {
                    bestProbability = probability;
                    detectedClass = classPrediction;
                }
            }

            displayPrediction(detectedClass);
            // For images, we don't clear the label automatically like webcam
        }

        function displayPrediction(className) {
            predictionLabel.textContent = className.toUpperCase();
            predictionLabel.className = ''; // Clear previous classes
            predictionLabel.classList.add(className.toLowerCase().replace(/\s/g, '-')); // Add class for styling

            // Update stats based on detected class only once per new valid detection
            if (className.toLowerCase() === 'reciclable' && lastPredictionClass !== 'reciclable') {
                incrementStat('stat1', 1); // Objetos Clasificados
                incrementStat('stat3', 0.1); // Pequeño incremento para Porcentaje Reciclado
            } else if (className.toLowerCase() === 'organico' && lastPredictionClass !== 'organico') {
                incrementStat('stat2', 0.05); // Pequeño incremento para CO2
            }
            // Ensure the label is visible when a prediction is made
            predictionLabel.style.display = 'block';
        }

        // WEBCAM CONTROLS
        async function startWebcam() {
            if (!model) {
                alert('El modelo aún no está cargado. Por favor, espera un momento.');
                return;
            }
            if (isWebcamActive) return; // Prevent multiple camera starts

            try {
                // Constraints for higher resolution and good illumination for mobile
                // Prefer facingMode: environment (rear camera)
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 }, // Attempt for higher resolution
                        height: { ideal: 720 },
                        // Optional: frameRate: { ideal: 30, max: 30 }
                    }
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.style.display = 'block';

                // Adjust the hidden canvas size to match the video feed
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                }, { once: true });


                outputImage.style.display = 'none';
                uploadInput.value = '';
                processImageButton.style.display = 'none';
                clearImageButton.style.display = 'none';
                predictionLabel.style.display = 'none'; // Start hidden

                startCameraButton.style.display = 'none';
                stopCameraButton.style.display = 'inline-flex';
                uploadButton.style.display = 'none';

                isWebcamActive = true;
                window.requestAnimationFrame(loop); // Start the prediction loop

                console.log('Webcam started for Teachable Machine.');

            } catch (error) {
                alert('Error al acceder a la cámara: ' + error.message + '. Asegúrate de permitir el acceso a la cámara y que esté disponible.');
                console.error(error);
                stopWebcam();
            }
        }

        function stopWebcam() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            video.style.display = 'none';
            predictionLabel.style.display = 'none';
            clearTimeout(predictionHideTimeout); // Clear any pending hide timeout

            startCameraButton.style.display = 'inline-flex';
            stopCameraButton.style.display = 'none';
            uploadButton.style.display = 'inline-flex'; // Show upload button again

            isWebcamActive = false;
            lastPredictionClass = ''; // Reset prediction state
            console.log('Webcam stopped.');
        }

        // EVENT LISTENERS
        startCameraButton.addEventListener('click', startWebcam);
        stopCameraButton.addEventListener('click', stopWebcam);

        uploadButton.addEventListener('click', () => {
            stopWebcam(); // Stop webcam if trying to upload
            uploadInput.click();
        });

        uploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    outputImage.src = e.target.result;
                    outputImage.style.display = 'block';
                    video.style.display = 'none';
                    predictionLabel.style.display = 'none'; // Hide label for new image

                    processImageButton.style.display = 'inline-flex';
                    clearImageButton.style.display = 'inline-flex';
                    startCameraButton.style.display = 'inline-flex';
                    uploadButton.style.display = 'none'; // Hide upload button after image selected
                };
                reader.readAsDataURL(file);
            }
        });

        processImageButton.addEventListener('click', () => {
            if (outputImage.src && outputImage.src !== '#') {
                predictImage(outputImage);
            } else {
                alert('No hay imagen para procesar. Por favor, sube una.');
            }
        });

        clearImageButton.addEventListener('click', () => {
            outputImage.src = '#';
            outputImage.style.display = 'none';
            predictionLabel.style.display = 'none';
            processImageButton.style.display = 'none';
            clearImageButton.style.display = 'none';
            uploadInput.value = '';
            uploadButton.style.display = 'inline-flex';
            // No need to clear canvas as it's internal for webcam now
        });

        // THEME TOGGLE
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            themeToggle.innerHTML = isDarkMode ? '<span class="material-icons">light_mode</span>' : '<span class="material-icons">dark_mode</span>';
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });

        // Load saved theme on startup
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.innerHTML = '<span class="material-icons">light_mode</span>';
        } else {
            themeToggle.innerHTML = '<span class="material-icons">dark_mode</span>';
        }

        // Initialize model on page load
        initModel();

        // Animated Stats (initial animation only, no continuous updates)
        function animateStatsInitial() {
            for (const key in statsData) {
                const stat = statsData[key];
                const element = document.getElementById(key);
                const increment = stat.target / 100; // 100 steps
                let currentVal = 0;

                const interval = setInterval(() => {
                    if (currentVal < stat.target) {
                        currentVal += increment;
                        if (currentVal > stat.target) currentVal = stat.target;
                        element.textContent = Math.round(currentVal) + stat.text;
                    } else {
                        clearInterval(interval);
                    }
                }, 20); // 20ms per step
            }
        }
        animateStatsInitial(); // Call on page load

        // Function to increment a stat value permanently
        function incrementStat(id, amount) {
            const stat = statsData[id];
            if (stat) {
                stat.value += amount;
                // Cap the value at the target if it goes over
                if (stat.value > stat.target) {
                    stat.value = stat.target;
                }
                document.getElementById(id).textContent = Math.round(stat.value) + stat.text;
            }
        }


        // Initial section display
        document.addEventListener('DOMContentLoaded', () => {
            showSection('home-section');
            // If you need the Google Maps API key, load it here.
            // Be sure to replace "YOUR_API_KEY" in the script tag
            // loadGoogleMapsScript();
        });
    </script>
    </body>
</html>
